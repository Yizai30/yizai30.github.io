---
title: 服务器维护记录
tags: [Server, Ubuntu]
categories: [Server]
---
# 服务器维护历程文档

## 概述
本文档记录了2025年12月11日至12月22日期间，服务器从出现故障到完全修复的完整过程。主要问题包括系统启动失败、文件系统挂载错误、systemd服务故障，最终通过系统重装和数据恢复解决了所有问题。

## 时间线

### 第零阶段：硬件故障修复（12月10日）
**问题背景**:
在开始排查软件问题之前，服务器出现了严重的硬件故障，导致系统无法稳定运行。

**关键发现：CPU过热故障**
- 系统启动时显示CPU过热警告
- 服务器在高负载下突然断电保护
- 系统运行极不稳定，无法进行任何有效的诊断工作

#### 硬件维修过程

**第一步：CPU硅脂重涂**
- 关闭服务器电源，断开所有外部连接
- 拆卸CPU散热器，发现旧硅脂已干涸失效
- 彻底清理CPU和散热器表面
- 重新涂抹高质量导热硅脂，确保均匀覆盖
- 重新安装散热器，调整到适当压力

**第二步：水冷系统故障诊断**
- 请人帮忙检查原水冷系统运行状态
- 发现水泵不工作，冷却液循环异常
- 确认散热效率严重下降，必须更换

**第三步：更换全新水冷系统**
- 采用维修店现货瓦尔基里水冷
- 完全拆卸故障的旧水冷设备
- 安装新的水冷系统，重新布置冷却管路
- 确保散热片与CPU表面接触良好，水冷泵工作正常
![瓦尔基里水冷装置](/images/2025-12-23-服务器维护记录/688bcd005c32a0a94d72bf52cc5bf785.jpg)
_瓦尔基里水冷装置_

#### 硬件修复效果
**温度改善**:
- 修复前：CPU空闲温度超过高温警戒，≥80°C（系统会发出警告，需要立即处理），负载时甚至到达100°C（系统会强制保护，可能导致断电）
- 修复后：CPU空闲温度约为35°C（安全范围，正常运行）

**系统稳定性提升**:
- 彻底消除了因过热导致的突然断电问题
- 系统可以长时间稳定运行
- 为后续的软件层面故障排查和修复提供了必要的硬件基础

**重要性说明**:
这一阶段的硬件修复是整个维修过程的基础。只有解决了CPU过热问题，确保系统不再因硬件故障而断电，才能进行后续的软件故障诊断和数据恢复工作。如果硬件问题未解决，任何软件层面的修复尝试都无法有效进行。

### 第一阶段：初期问题发现（12月11日）
**文件**: `修复netstat无输出与53端口解析失败-20251211172116.txt`

**关键问题**:
- netstat命令无输出
- 53端口DNS解析失败
- 系统网络连接异常

**初步诊断**:
- 系统基础网络堆栈出现问题
- 可能存在系统服务异常

### 第二阶段：系统紧急模式（12月13日）
**文件**: `修复系统紧急模式只读文件系统问题-20251213125009.txt`

**问题升级**:
- 系统启动进入紧急模式（Emergency Mode）
- 根文件系统变为只读状态
- 无法正常执行系统管理命令

**解决尝试**:
- 使用Live USB启动盘进行系统恢复
- 尝试文件系统检查和修复
- 分析/etc/fstab配置文件

### 第三阶段：恢复工具准备（12月13日）
**文件**: `Ubuntu U盘启动盘制作与使用指南-20251213143505.txt`

**解决方案**:
- 制作Ubuntu Live USB启动盘
- 使用Live环境进行系统诊断和修复
- 建立临时工作环境进行数据抢救

### 第四阶段：存储设备检查（12月15日）
**文件**: `NVMe硬盘只读问题解决指南-20251215215138.txt`

**存储设备检查**:
- 硬件故障已在第零阶段排除，重点关注存储设备
- NVMe硬盘状态检查
- 排除磁盘物理故障可能性

**文件**: `Ubuntu下进行SMART测试完整指南-20251216164524.txt`

**诊断结果**:
- NVMe硬盘S.M.A.R.T.状态正常，无物理坏道
- 硬件层面完全健康
- 确认问题集中在系统软件层面

### 第五阶段：启动失败分析（12月16日）
**文件**: `解决Ubuntu启动报错：挂载单元失败问题-20251216181300.txt`

**核心问题**:
```
[FAILED] Failed to mount Huge Pages File System
[FAILED] Failed to mount POSIX Message Queue File System
[FAILED] Failed to mount Kernel Debug File System
[FAILED] Failed to mount Kernel Trace File System
[FAILED] Failed to mount FUSE Control File System
[FAILED] Failed to mount Kernel Configuration File System
```

**分析结论**:
- 35个systemd单元启动失败
- 文件系统挂载配置存在严重问题
- 系统服务依赖关系混乱

### 第六阶段：系统配置修复尝试（12月17日）
**文件**: `修改硬盘错误参数：副作用与风险分析-20251217121847.txt`

**修复尝试**:
- 修改/etc/fstab挂载参数
- 调整文件系统错误处理策略
- 尝试恢复系统读写权限

**遇到的问题**:
- 命令执行被"吞掉"（无响应）
- dmesg日志无法查看
- 系统状态不稳定

### 第七阶段：根本原因发现（12月17日）
**文件**: `df-20251217153548.txt` 和 `chat-System Issue With Conda Interference.txt`

**关键发现**:
- Conda环境干扰系统PATH变量
- GRUB配置更新失败
- 系统工具执行异常

**核心技术问题**:
1. **Conda PATH污染**: 系统PATH中包含Conda路径，导致系统工具找到错误的执行文件
2. **GRUB更新失败**: update-grub命令无法正常执行
3. **系统环境破坏**: Conda环境变量影响了系统级操作

## 最终解决方案

### 1. 系统重装决策
经过多次尝试修复失败后，决定进行系统重装：
- 数据已通过Live USB环境备份
- 系统文件损坏严重，修复成本过高
- 重装是 fastest path to recovery

### 2. 数据恢复策略
**用户和组管理**:

#### 2.1 关键步骤回顾
| 步骤 | 操作 | 命令示例 |
|------|------|---------|    
| 1 | 挂载外置硬盘 | `sudo mount /dev/sdb1 /mnt/backup` |
| 2 | 分析备份用户 | `awk -F: '$3 >= 1000 {print $1, $3}' /mnt/backup/etc/passwd` |         
| 3 | 修改冲突UID | `awk -F: 'BEGIN{OFS=":"} $1 == "gpuserver1106" { $3 = 1010; $4 = 1010 } 1' /mnt/backup/etc/passwd > /tmp/passwd.fixed` |                  
| 4 | 恢复用户账户 | `sudo cat /tmp/passwd.fixed \| sudo tee -a /etc/passwd` |                   
| 5 | 恢复密码信息 | `sudo cat /tmp/shadow.fixed \| sudo tee -a /etc/shadow` |     
| 6 | 恢复home目录 | `sudo rsync -aAXHvh /mnt/backup/home/ /home/` |                                     
| 7 | 修复文件所有权 | `sudo chown -R 1010:1010 /home/gpuserver1106` |                               
| 8 | 清理重复条目 | `sudo vipw` 删除重复的用户条目 |  
| 9 | 验证 | `id gpuserver1106` |             
| 10 | 测试登录 | `su - gpuserver1106` |                                                                                        
#### 2.2 关键注意事项     
1. **UID唯一性**：确保每个用户的UID在系统中是唯一的      
2. **备份先行**：修改任何系统文件前先备份 
3. **安全编辑**：使用 `vipw` 和 `vipw -s` 编辑用户文件     
4. **密码保持**：恢复shadow文件即可保留原密码        
5. **权限完整**：恢复用户组以确保正确的访问权限  

#### 2.3 遇到的问题和解决         
                      
| 问题 | 原因 | 解决方法 |       
|------|------|---------|       
| `id gpuserver1106` 显示ubuntu用户 | 用户条目重复 | 使用vipw删除UID 1000的条目 |           
| 文件所有权错误 | UID从1000改为1010后未更新 | `chown -R 1010:1010 /home/gpuserver1106` |     
| 无法登录 | shadow文件未恢复或条目重复 | 同步shadow文件，删除重复条目 |  
                      
#### 2.4 系统用户检查  
```bash 
# 检查所有用户  
awk -F: '$3 >= 1000 {print $1, $3, $6}' /etc/passwd 
``` 
#### 2.5 多用户状态  
恢复后系统包含以下用户：  
- ubuntu (UID 1000) - 新系统安装时创建    
- gpuserver1106 (UID 1010) - 从备份恢复      
- testuser (UID 1001) - 从备份恢复    
- chenshi (UID 1002) - 从备份恢复   
- liyizhe (UID 1003) - 从备份恢复  
- ekay (UID 1004) - 从备份恢复  
- hammer (UID 1005) - 从备份恢复  
- ssg (UID 1006) - 从备份恢复  
- Meowww (UID 1007) - 从备份恢复  
- czh (UID 1008) - 从备份恢复 

#### 2.6 登录测试     
所有用户应该能够： 
- 使用原密码登录系统   
- 访问各自的home目录    
- 拥有相应的权限（sudo、docker等）

**关键数据目录**:
  1. 用户数据目录

  - /home/ - 用户数据
    - 用户文档、代码、配置文件
    - SSH密钥
    - 个人环境配置

  2. 系统配置目录（选择性恢复）

  - /etc/ssh/ - SSH配置（未恢复）
    - SSH主机密钥（避免客户端"WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED"警告）
    - sshd_config配置文件
    - 由于未恢复，用户在客户端需要执行 ssh-keygen -R "[139.224.239.149]:10090" 删除旧的服务器密钥
  - /etc/netplan/ - 网络配置（未恢复）
    - 静态IP配置
    - 网络接口设置
  - /etc/cron.d/ - 定时任务（未恢复）
    - 自定义cron任务
  - /etc/crontab - 系统级定时任务（未恢复）
  - /etc/systemd/system/ - 自定义systemd服务（未恢复）
    - 用户创建的服务单元文件

  3. 服务数据目录

  - /var/www/ - Web服务数据（不存在）
    - 网站文件
    - Web应用数据
  - /var/lib/mysql/ - MySQL数据库数据（不存在）
    - 数据库文件
    - 如果运行数据库服务

  4. 应用程序数据

  - /opt/ - 自定义应用程序
    - frp
    - miniconda
  - /srv/ - 服务数据（不存在）
    - 额外的服务数据目录

  5. 用户账户信息（特殊处理）

  需要手动处理，不能直接恢复：（手动处理和重装系统后与新用户ubuntu之间的冲突）
  - /etc/passwd - 用户账户信息
  - /etc/shadow - 用户密码信息
  - /etc/group - 用户组信息

  处理方法：
  - 提取UID ≥ 1000的用户
  - 检查并解决UID冲突（如gpuserver1106用户从UID 1000改为1010）
  - 使用awk等工具选择性追加，避免覆盖新系统用户

  6. 备份的其他有用文件

  - /var/log/apt/history.log - 已安装软件包列表（未恢复）
  - /root/ - root用户的配置和数据（未恢复）

  ⚠️ 不应恢复的目录

  修复记录中明确指出以下目录不应恢复：
  - /etc/passwd、/etc/shadow、/etc/group - 用户账户信息
  - /etc/fstab - 文件系统挂载配置
  - 整个/etc目录 - 不能盲目恢复整个/etc，会破坏新系统

  备份命令

  修复中使用的备份命令：
  sudo rsync -aAXHvh --progress /mnt/myroot/ /path/to/external_hard_drive/

  这个命令备份了整个系统，包括所有关键数据目录，保留了权限、所有权、ACLs、扩展属性和硬链接。
  修复后，可以通过这个命令进行恢复：
  sudo rsync -aAXHvh --progress /path/to/external_hard_drive/target_path/ /target_path/

### 3. 系统优化配置
**硬件配置**:
- NVIDIA RTX 4090 x 2 GPU配置
- 水冷散热系统

**软件环境**:
- 全局nvcc环境
- 多用户miniconda环境
- 使用docker环境隔离技术
- external hard disk备份系统数据
- sensors工具检查CPU温度

## 技术要点总结

### Conda干扰问题的技术细节

**问题机理**:
```bash
# 错误的PATH配置示例，在/etc/environment中配置cuda，需要写死路径
PATH="/opt/cuda_toolkit_env/bin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
LD_LIBRARY_PATH="/opt/cuda_toolkit_env/lib64"
```

**解决方案**:
```bash
# 在 /etc/profile.d 中使用 cuda.sh 和 conda.sh 在多用户登录时自动配置环境
source /etc/profile.d/cuda.sh
source /etc/profile.d/conda.sh
# 在 /etc/ld.so.conf.d 中添加 cuda.conf，则不需要配置 LD_LIBRARY_PATH
echo "/usr/local/cuda/lib64" > /etc/ld.so.conf.d/cuda.conf
```

### 系统恢复最佳实践

1. **环境隔离**: 重要系统操作应使用干净的环境变量
2. **PATH管理**: 避免开发工具污染系统PATH
3. **备份策略**: 定期备份关键配置和数据
4. **监控机制**: 建立系统健康监控

### 故障诊断工具

**硬件诊断**:
- `smartctl` - 硬盘S.M.A.R.T.检测
- `memtest86+` - 内存测试（未使用）
- `stress` - 系统压力测试（未使用）

**软件诊断**:
- `journalctl` - 系统日志分析
- `systemctl` - 服务状态检查
- `fsck` - 文件系统检查

## 经验教训

### 1. 环境管理的重要性
- 对于多用户使用minconda，开发环境应与系统环境严格分离

### 2. 系统维护策略
- 定期进行系统健康检查，包括硬件和软件
- 保持系统更新，但不盲目更新
- 维护详细的系统配置文档

### 3. 故障响应流程
- 及时备份数据防止进一步损失
- 采用渐进式问题排查方法
- 必要时选择重装而非盲目修复

## 结论

本次服务器维修过程是一个完整的故障排除案例，展现了从硬件修复到软件重构的系统化解决方案。

### 维修过程的关键顺序
1. **第零阶段 - 硬件修复**: 通过重涂CPU硅脂和更换故障水冷系统，解决了CPU过热导致的系统断电问题，为后续工作奠定了稳定的硬件基础
2. **第一阶段至第七阶段 - 软件故障排查**: 系统性地诊断和尝试修复各种软件层面的问题
3. **最终解决**: 识别出Conda环境干扰、systemctl服务启动失败、多个文件挂载点挂在失败等难以修复的软件问题，通过系统重装和数据恢复彻底解决问题

### 关键成功因素
- **正确的故障排查顺序**: 先硬件后软件，确保系统稳定运行是进行软件修复的前提
- **彻底的硬件修复**: CPU过热问题的解决使系统能够长时间稳定运行，为软件诊断创造条件
- **系统化的方法**: 从简单到复杂，从外部到内部的渐进式排查
- **果断的决策**: 在修复成本过高时，及时选择重装系统

此次维修过程为今后的系统管理提供了宝贵的经验：
1. **硬件稳定性是基础**: 在排查软件问题前，必须确保硬件系统工作正常
2. **严格的环境分离**: 开发环境（如Conda）应与系统环境严格分离，避免PATH污染
3. **备份**: 定期备份关键配置和数据是数据安全的保障
4. **温度检查**: 可以使用sensors检查硬件温度，及时发现过热问题

服务器现已恢复正常运行，硬件温度得到有效控制，软件环境配置规范，需时常监控和检查服务器的健康状态，以预防类似问题的再次发生。

---
*文档生成时间: 2025年12月22日*
*文档人为编辑时间：2025年12月23日*
*维修周期: 2025年12月11日 - 12月22日*