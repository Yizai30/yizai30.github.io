---
title: 增大交换空间以解决虚拟内存不足
tags: [Out of Memory]
categories: [Virtual Memory]
---
### 问题
运行CUDA程序时，虚拟内存不足。
```bash
(   ●  ) NerfAcc: Setting up CUDA (This may take a few minutes the first time)Killed
```
Setting up CUDA 被自动 Killed 了，怎么办？

### 检查系统资源
```bash
# 查看内存使用情况
free -h

# 查看被kill的进程日志
dmesg | grep -i kill
```
运行结果如下：
```bash
(drawingspinup) yizai@WIN-YIZAI:~/repos/DrawingSpinUp/2_charactor_reconstructor$ free -h
               total        used        free      shared  buff/cache   available
Mem:            15Gi        10Gi       4.2Gi       0.0Ki       460Mi       4.3Gi
Swap:          4.0Gi       1.8Gi       2.2Gi
(drawingspinup) yizai@WIN-YIZAI:~/repos/DrawingSpinUp/2_charactor_reconstructor$ dmesg | grep -i kill
...
[121177.939221] Out of memory: Killed process 231208 (python) total-vm:49395968kB, anon-rss:51264kB, file-rss:0kB, shmem-rss:101992kB, UID:1000 pgtables:6652kB oom_score_adj:0
[121207.442841] node invoked oom-killer: gfp_mask=0x1100cca(GFP_HIGHUSER_MOVABLE), order=0, oom_score_adj=0
[121207.442927]  oom_kill_process.cold+0xb/0x10
[121207.443705] oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=/,mems_allowed=0,global_oom,task_memcg=/user.slice/user-1000.slice/session-c1.scope,task=cicc,pid=232574,uid=1000
[121207.443727] Out of memory: Killed process 232574 (cicc) total-vm:1857920kB, anon-rss:1504756kB, file-rss:0kB, shmem-rss:0kB, UID:1000 pgtables:3424kB oom_score_adj:0
```

### 查看当前交换空间状态

```bash
# 查看所有交换空间
swapon --show

# 或使用
cat /proc/swaps
```

### 删除旧的交换文件
先清理旧的交换文件，如果旧的交换文件不存在，`swapoff: /swapfile: swapoff failed: No such file or directory`，则直接创建新的交换文件。
```bash
sudo swapoff /swapfile
sudo rm /swapfile
```

### 创建新的交换文件
根据你的内存情况（15GB内存 + 4GB交换空间已用完），建议创建更大的交换文件：

```bash
# 创建16GB的交换文件（根据你的磁盘空间决定）
sudo fallocate -l 16G /swapfile

# 设置权限
sudo chmod 600 /swapfile

# 格式化为交换空间
sudo mkswap /swapfile

# 启用交换空间
sudo swapon /swapfile

# 验证
swapon --show
free -h
```

### 总结
根据磁盘空间，创建更大的交换文件，以解决虚拟内存不足的问题。
